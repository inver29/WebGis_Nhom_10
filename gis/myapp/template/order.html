{% extends "base.html" %}
{% block title %}ƒê·∫∑t h√†ng{% endblock %}

{% block content_wrapper %}
<div class="container mt-4">
    <h3>T·∫°o ƒë∆°n ƒë·∫∑t h√†ng</h3>

    {% if pharmacy %}
        <div class="alert alert-success">
            <strong>Chi nh√°nh:</strong> {{ pharmacy.name }} <br>
            <strong>Kho·∫£ng c√°ch:</strong> {{ distance }} km <br>
            <strong>Ph√≠ ship:</strong> {{ shipping_fee }} VNƒê
        </div>
    {% else %}
        <a href="{% url 'map_view' %}" class="btn btn-success">
            üìç Ch·ªçn chi nh√°nh ƒë·∫∑t h√†ng
        </a>
    {% endif %}
    

    {% if pharmacy %}
    <form method="post" class="mt-3">
        {% csrf_token %}
        <input type="hidden" name="shipping_fee" value="{{ shipping_fee }}">

        <div class="mb-3">
            <label>Lo·∫°i thu·ªëc</label>
            <select name="medicine" class="form-control" required>
                {% for m in medicines %}
                    <option value="{{ m.id }}" data-price="{{ m.price }}">
                        {{ m.name }} ({{ m.price }} VNƒê)
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3">
            <label>S·ªë l∆∞·ª£ng</label>
            <input type="number" name="quantity" value="1" min="1" class="form-control">
        </div>

        <div class="mb-3">
            <label>Ph∆∞∆°ng th·ª©c thanh to√°n</label>
            <input class="form-control" value="Thanh to√°n khi nh·∫≠n h√†ng (COD)" disabled>
        </div>

        <div class="mb-3">
            <strong>Th√†nh ti·ªÅn:</strong>
            <span id="total">0</span> VNƒê
        </div>

        <button type="button"
                class="btn btn-success"
                data-url="{% url 'home' %}" 
                onclick="window.location.href=this.getAttribute('data-url')">
            X√°c nh·∫≠n ƒë·∫∑t h√†ng
        </button>
    </form>
    {% endif %}
</div>

<script>
const qty = document.querySelector('[name="quantity"]');
const med = document.querySelector('[name="medicine"]');
const total = document.getElementById('total');
const ship = parseInt("{{ shipping_fee|default:0 }}");
function calc() {
    if (!med) return;
    const price = parseInt(med.selectedOptions[0].dataset.price);
    const q = parseInt(qty.value);
    total.innerText = (price * q + ship).toLocaleString();
}

qty?.addEventListener('input', calc);
med?.addEventListener('change', calc);
calc();
</script>

{% endblock %}
